# Há»‡ Thá»‘ng Quáº£n LÃ½ License - PromptFlow Desktop

Há»‡ thá»‘ng quáº£n lÃ½ license hoÃ n chá»‰nh cho á»©ng dá»¥ng Electron, bao gá»“m backend API, client library vÃ  tÃ­ch há»£p vÃ o á»©ng dá»¥ng.

## Tá»•ng Quan Há»‡ Thá»‘ng

### Kiáº¿n TrÃºc

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USERS & CLIENTS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Admin Panel  â”‚         â”‚ Electron App â”‚                â”‚
â”‚  â”‚ (Dashboard)  â”‚         â”‚   (Client)   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                        â”‚                         â”‚
â”‚         â”‚ HTTPS                  â”‚ HTTPS                   â”‚
â”‚         â–¼                        â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚     License Server (API)            â”‚                  â”‚
â”‚  â”‚  - Auth (JWT)                       â”‚                  â”‚
â”‚  â”‚  - User Management                  â”‚                  â”‚
â”‚  â”‚  - Admin Management                 â”‚                  â”‚
â”‚  â”‚  - License Activation               â”‚                  â”‚
â”‚  â”‚  - Renewal Requests                 â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                â”‚                                            â”‚
â”‚                â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚         MySQL Database              â”‚                  â”‚
â”‚  â”‚  - users                            â”‚                  â”‚
â”‚  â”‚  - apps                             â”‚                  â”‚
â”‚  â”‚  - licenses                         â”‚                  â”‚
â”‚  â”‚  - activations                      â”‚                  â”‚
â”‚  â”‚  - renew_requests                   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Luá»“ng Hoáº¡t Äá»™ng

#### 1. Luá»“ng KÃ­ch Hoáº¡t License (First Time)

```
User má»Ÿ App â†’ ChÆ°a cÃ³ license â†’ Hiá»ƒn thá»‹ License Dialog
             â†“
User nháº­p License Key â†’ Gá»­i lÃªn Server (POST /activate)
             â†“
Server kiá»ƒm tra:
  - License há»£p lá»‡?
  - App Ä‘Ãºng khÃ´ng?
  - CÃ²n háº¡n?
  - Sá»‘ thiáº¿t bá»‹ < max_devices?
             â†“
Server táº¡o Activation & tráº£ JWT Token
             â†“
Client lÆ°u Token vÃ o local (userData/.promptflow/license/)
             â†“
App khá»Ÿi Ä‘á»™ng bÃ¬nh thÆ°á»ng
```

#### 2. Luá»“ng Kiá»ƒm Tra License (Subsequent Launches)

```
User má»Ÿ App â†’ Äá»c Token tá»« file local
             â†“
Verify Token:
  - Token há»£p lá»‡?
  - ChÆ°a háº¿t háº¡n (30 ngÃ y)?
  - App Ä‘Ãºng?
             â†“
    Valid? â†’ VÃ o App
    Invalid? â†’ YÃªu cáº§u nháº­p License láº¡i
```

#### 3. Luá»“ng Admin Táº¡o License

```
Admin Ä‘Äƒng nháº­p Dashboard â†’ POST /admin/licenses
             â†“
Chá»n User, App, Max Devices, Expires Date
             â†“
Server sinh License Key ngáº«u nhiÃªn (XXXX-XXXX-XXXX-XXXX)
             â†“
LÆ°u vÃ o database vá»›i status = 'active'
             â†“
Admin gá»­i License Key cho User (email, etc.)
```

#### 4. Luá»“ng User Xin Gia Háº¡n

```
User login Dashboard â†’ Xem danh sÃ¡ch Licenses cá»§a mÃ¬nh
             â†“
Click "Request Renewal" â†’ POST /user/licenses/:id/renew-requests
             â†“
Táº¡o renew_request vá»›i status = 'pending'
             â†“
Admin nháº­n Ä‘Æ°á»£c request â†’ Xem trong Admin Panel
             â†“
Admin approve/reject â†’ PATCH /admin/renew-requests/:id
             â†“
Náº¿u approved: Cáº­p nháº­t expires_at cá»§a license (+30 ngÃ y)
```

---

## Cáº¥u TrÃºc ThÆ° Má»¥c

```
/home/user/automation/
â”œâ”€â”€ license-server/              # Backend API Server
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.js         # ÄÄƒng kÃ½, Ä‘Äƒng nháº­p
â”‚   â”‚   â”‚   â”œâ”€â”€ user.js         # User xem license, gá»­i renewal request
â”‚   â”‚   â”‚   â”œâ”€â”€ admin.js        # Admin quáº£n lÃ½ license, xá»­ lÃ½ requests
â”‚   â”‚   â”‚   â””â”€â”€ activation.js   # Activate license cho client app
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â””â”€â”€ auth.js         # JWT middleware
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â”œâ”€â”€ database.js     # MySQL connection pool
â”‚   â”‚   â”‚   â””â”€â”€ keys.js         # RSA keys
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â””â”€â”€ crypto.js       # Hash device ID, generate license key
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â”œâ”€â”€ init-db.js          # Khá»Ÿi táº¡o database
â”‚   â”‚   â”œâ”€â”€ create-admin.js     # Táº¡o admin user
â”‚   â”‚   â””â”€â”€ generate-keys.sh    # Táº¡o RSA key pair
â”‚   â”œâ”€â”€ schema.sql              # Database schema
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ .env.example
â”‚   â””â”€â”€ DEPLOYMENT.md           # HÆ°á»›ng dáº«n triá»ƒn khai
â”‚
â”œâ”€â”€ license-client/              # Client Library
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ index.js            # LicenseClient class
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ license-manager.js           # License manager cho Electron app
â”œâ”€â”€ electron-main.js             # Electron main process (Ä‘Ã£ tÃ­ch há»£p license)
â”œâ”€â”€ electron-preload.js          # Preload script (expose license API)
â”‚
â””â”€â”€ LICENSE_SYSTEM_README.md     # File nÃ y
```

---

## Database Schema

### Báº£ng: `users`

| Field           | Type          | Description                    |
|-----------------|---------------|--------------------------------|
| id              | INT           | Primary key                    |
| email           | VARCHAR(255)  | Email (unique)                 |
| password_hash   | VARCHAR(255)  | Bcrypt hash cá»§a password       |
| full_name       | VARCHAR(255)  | Há» tÃªn                         |
| role            | ENUM          | 'user' hoáº·c 'admin'            |
| created_at      | TIMESTAMP     | NgÃ y táº¡o                       |
| last_login_at   | TIMESTAMP     | Láº§n login cuá»‘i                 |

### Báº£ng: `apps`

| Field        | Type         | Description                        |
|--------------|--------------|------------------------------------|
| id           | INT          | Primary key                        |
| code         | VARCHAR(50)  | MÃ£ app (unique), VD: 'PROMPTFLOW_DESKTOP' |
| name         | VARCHAR(255) | TÃªn app                            |
| description  | TEXT         | MÃ´ táº£                              |
| created_at   | TIMESTAMP    | NgÃ y táº¡o                           |

### Báº£ng: `licenses`

| Field       | Type          | Description                           |
|-------------|---------------|---------------------------------------|
| id          | INT           | Primary key                           |
| user_id     | INT           | FK -> users.id (chá»§ sá»Ÿ há»¯u license)   |
| app_id      | INT           | FK -> apps.id                         |
| license_key | VARCHAR(100)  | License key (unique)                  |
| max_devices | INT           | Sá»‘ mÃ¡y tá»‘i Ä‘a Ä‘Æ°á»£c activate           |
| expires_at  | TIMESTAMP     | NgÃ y háº¿t háº¡n (NULL = vÃ´ háº¡n)          |
| status      | ENUM          | 'active', 'revoked', 'expired'        |
| meta        | JSON          | Metadata khÃ¡c                         |
| created_at  | TIMESTAMP     | NgÃ y táº¡o                              |

### Báº£ng: `activations`

| Field              | Type         | Description                           |
|--------------------|--------------|---------------------------------------|
| id                 | INT          | Primary key                           |
| license_id         | INT          | FK -> licenses.id                     |
| device_hash        | VARCHAR(64)  | SHA256 hash cá»§a device ID             |
| first_activated_at | TIMESTAMP    | Láº§n activate Ä‘áº§u tiÃªn                 |
| last_checkin_at    | TIMESTAMP    | Láº§n checkin cuá»‘i (má»—i láº§n má»Ÿ app)     |
| status             | ENUM         | 'active', 'banned'                    |
| meta               | JSON         | ThÃ´ng tin thiáº¿t bá»‹, app version, etc. |

**UNIQUE KEY:** (license_id, device_hash)

### Báº£ng: `renew_requests`

| Field                  | Type      | Description                           |
|------------------------|-----------|---------------------------------------|
| id                     | INT       | Primary key                           |
| user_id                | INT       | FK -> users.id (ngÆ°á»i gá»­i request)    |
| license_id             | INT       | FK -> licenses.id                     |
| message                | TEXT      | LÃ½ do xin gia háº¡n                     |
| status                 | ENUM      | 'pending', 'approved', 'rejected'     |
| created_at             | TIMESTAMP | NgÃ y gá»­i request                      |
| processed_at           | TIMESTAMP | NgÃ y xá»­ lÃ½ (NULL náº¿u chÆ°a xá»­ lÃ½)      |
| processed_by_admin_id  | INT       | FK -> users.id (admin xá»­ lÃ½)          |
| admin_notes            | TEXT      | Ghi chÃº cá»§a admin                     |

---

## API Endpoints

### Authentication

#### `POST /auth/register`
ÄÄƒng kÃ½ tÃ i khoáº£n user má»›i.

**Request:**
```json
{
  "email": "user@example.com",
  "password": "password123",
  "fullName": "John Doe"
}
```

**Response:**
```json
{
  "success": true,
  "token": "jwt_token_here",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "fullName": "John Doe",
    "role": "user"
  }
}
```

#### `POST /auth/login`
ÄÄƒng nháº­p.

**Request:**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**Response:**
```json
{
  "success": true,
  "token": "jwt_token_here",
  "user": { ... }
}
```

---

### User Routes (Requires JWT)

#### `GET /user/licenses`
Xem danh sÃ¡ch licenses cá»§a user hiá»‡n táº¡i.

**Headers:**
```
Authorization: Bearer {jwt_token}
```

**Response:**
```json
{
  "success": true,
  "licenses": [
    {
      "id": 1,
      "licenseKey": "ABCD-1234-EFGH-5678",
      "appCode": "PROMPTFLOW_DESKTOP",
      "appName": "PromptFlow Desktop",
      "maxDevices": 2,
      "expiresAt": "2025-12-31T23:59:59.000Z",
      "status": "active",
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

#### `POST /user/licenses/:id/renew-requests`
Gá»­i yÃªu cáº§u gia háº¡n license.

**Request:**
```json
{
  "message": "TÃ´i muá»‘n gia háº¡n thÃªm 1 nÄƒm"
}
```

---

### Admin Routes (Requires JWT + Admin Role)

#### `POST /admin/licenses`
Táº¡o license má»›i.

**Request:**
```json
{
  "userId": 5,
  "appId": 1,
  "maxDevices": 2,
  "expiresAt": "2025-12-31T23:59:59.000Z",
  "status": "active"
}
```

**Response:**
```json
{
  "success": true,
  "licenseId": 10,
  "licenseKey": "ABCD-1234-EFGH-5678"
}
```

#### `PATCH /admin/renew-requests/:id`
Xá»­ lÃ½ yÃªu cáº§u gia háº¡n.

**Request:**
```json
{
  "status": "approved",
  "adminNotes": "ÄÃ£ gia háº¡n thÃªm 30 ngÃ y",
  "extendDays": 30
}
```

---

### Activation Routes (Public)

#### `POST /activate`
KÃ­ch hoáº¡t license cho thiáº¿t bá»‹.

**Request:**
```json
{
  "licenseKey": "ABCD-1234-EFGH-5678",
  "appCode": "PROMPTFLOW_DESKTOP",
  "deviceId": "unique-device-id-hash",
  "appVersion": "1.0.0"
}
```

**Response:**
```json
{
  "success": true,
  "token": "jwt_activation_token_here",
  "expiresAt": "2025-02-04T00:00:00.000Z",
  "license": {
    "expiresAt": "2025-12-31T23:59:59.000Z",
    "status": "active",
    "appCode": "PROMPTFLOW_DESKTOP",
    "maxDevices": 2
  }
}
```

---

## Triá»ƒn Khai

### 1. Backend Server

Xem chi tiáº¿t táº¡i: [`license-server/DEPLOYMENT.md`](license-server/DEPLOYMENT.md)

**TÃ³m táº¯t:**
```bash
# TrÃªn VPS Ubuntu
cd ~/apps/license-server
npm install --production
npm run init-db
npm run create-admin
pm2 start src/index.js --name license-server
```

### 2. Cáº¥u HÃ¬nh Nginx

```nginx
server {
    listen 443 ssl;
    server_name api.dangthanhson.com;

    ssl_certificate /etc/letsencrypt/live/api.dangthanhson.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.dangthanhson.com/privkey.pem;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. TÃ­ch Há»£p VÃ o Electron App

**Copy public key:**
```bash
# Copy public key tá»« server
scp licenseapp@your-vps:/home/licenseapp/apps/license-server/keys/public.pem ./keys/
```

**Cáº­p nháº­t `license-manager.js`:**
```javascript
const LICENSE_CONFIG = {
  APP_CODE: 'PROMPTFLOW_DESKTOP',
  APP_VERSION: '1.0.0',
  SERVER_URL: 'https://api.dangthanhson.com',
  PUBLIC_KEY: fs.readFileSync('./keys/public.pem', 'utf8')
};
```

**Build Electron app:**
```bash
npm run build:exe
```

---

## Báº£o Máº­t

### 1. Server Side

- âœ… HTTPS báº¯t buá»™c (SSL certificate)
- âœ… JWT authentication cho user/admin
- âœ… RSA signing cho activation tokens
- âœ… Device ID Ä‘Æ°á»£c hash trÆ°á»›c khi lÆ°u
- âœ… Rate limiting cho /activate endpoint
- âœ… Password hashing vá»›i bcrypt
- âœ… SQL injection prevention (prepared statements)
- âœ… Private key chá»‰ náº±m trÃªn server

### 2. Client Side

- âœ… Public key verify activation token
- âœ… Token cÃ³ thá»i háº¡n (30 ngÃ y)
- âœ… Device ID unique cho má»—i mÃ¡y
- âœ… License data lÆ°u trong userData (khÃ³ truy cáº­p)
- âœ… Code obfuscation khi build production

### 3. Recommendations

- ğŸ”’ ThÆ°á»ng xuyÃªn update dependencies
- ğŸ”’ Monitor logs Ä‘á»ƒ phÃ¡t hiá»‡n abuse
- ğŸ”’ Implement hardware fingerprinting nÃ¢ng cao
- ğŸ”’ Add IP whitelisting cho admin panel
- ğŸ”’ Implement 2FA cho admin accounts
- ğŸ”’ Regular database backups
- ğŸ”’ Rotate keys Ä‘á»‹nh ká»³

---

## Testing

### Test Backend API

```bash
# Health check
curl https://api.dangthanhson.com/health

# Register
curl -X POST https://api.dangthanhson.com/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","password":"123456","fullName":"Test"}'

# Activate
curl -X POST https://api.dangthanhson.com/activate \
  -H "Content-Type: application/json" \
  -d '{"licenseKey":"XXXX-XXXX-XXXX-XXXX","appCode":"PROMPTFLOW_DESKTOP","deviceId":"test123","appVersion":"1.0.0"}'
```

### Test Electron App

1. **First launch (chÆ°a cÃ³ license):**
   - Má»Ÿ app â†’ License dialog xuáº¥t hiá»‡n
   - Nháº­p license key â†’ Click Activate
   - ThÃ nh cÃ´ng â†’ App má»Ÿ

2. **Subsequent launches:**
   - Má»Ÿ app â†’ Tá»± Ä‘á»™ng verify token â†’ VÃ o app luÃ´n

3. **Invalid license:**
   - XÃ³a file token: `~/.promptflow/license/license_token.json`
   - Má»Ÿ app â†’ License dialog xuáº¥t hiá»‡n láº¡i

---

## Workflow Sá»­ Dá»¥ng

### Cho Admin

1. Login vÃ o admin dashboard
2. Táº¡o license cho user:
   - Chá»n user (email)
   - Chá»n app (PROMPTFLOW_DESKTOP)
   - Set max_devices (vÃ­ dá»¥: 2)
   - Set expires_at (vÃ­ dá»¥: 2025-12-31)
   - Click "Create License"
3. Copy license key vÃ  gá»­i cho user
4. Xem danh sÃ¡ch licenses, activations
5. Xá»­ lÃ½ renewal requests tá»« users

### Cho User

1. Nháº­n license key tá»« admin (qua email)
2. Má»Ÿ PromptFlow Desktop láº§n Ä‘áº§u
3. Nháº­p license key vÃ o dialog
4. Sá»­ dá»¥ng app bÃ¬nh thÆ°á»ng
5. Náº¿u muá»‘n gia háº¡n:
   - Login vÃ o dashboard (náº¿u cÃ³)
   - Gá»­i renewal request
   - Äá»£i admin approve

---

## Roadmap

### Phase 1 (Current)
- âœ… Backend API hoÃ n chá»‰nh
- âœ… Database schema
- âœ… Client library
- âœ… Electron integration
- âœ… Basic license activation

### Phase 2 (Future)
- â³ Admin dashboard UI (React/Vue)
- â³ User dashboard UI
- â³ Email notifications
- â³ Payment integration
- â³ Auto-renewal
- â³ Analytics & reporting

### Phase 3 (Advanced)
- â³ Multi-tier licensing (Basic/Pro/Enterprise)
- â³ Trial licenses
- â³ License transfer
- â³ Offline activation
- â³ Hardware binding nÃ¢ng cao

---

## FAQ

**Q: User cÃ³ thá»ƒ crack license khÃ´ng?**
A: KhÃ³, nhÆ°ng khÃ´ng thá»ƒ 100% chá»‘ng crack. Há»‡ thá»‘ng sá»­ dá»¥ng RSA signing, device binding, vÃ  server-side verification Ä‘á»ƒ lÃ m khÃ³ viá»‡c crack. NÃªn combine vá»›i code obfuscation vÃ  regular updates.

**Q: Náº¿u user format mÃ¡y thÃ¬ sao?**
A: Device ID sáº½ thay Ä‘á»•i, cáº§n activate láº¡i. Náº¿u Ä‘Ã£ Ä‘áº¡t max_devices, user cáº§n liÃªn há»‡ admin Ä‘á»ƒ revoke device cÅ©.

**Q: License key cÃ³ thá»ƒ dÃ¹ng cho nhiá»u mÃ¡y?**
A: CÃ³, nhÆ°ng giá»›i háº¡n bá»Ÿi `max_devices`. VÃ­ dá»¥ max_devices=2 thÃ¬ chá»‰ activate Ä‘Æ°á»£c 2 mÃ¡y.

**Q: Token háº¿t háº¡n 30 ngÃ y thÃ¬ sao?**
A: App sáº½ tá»± Ä‘á»™ng gá»i `/activate` láº¡i vá»›i cÃ¹ng license key Ä‘á»ƒ láº¥y token má»›i (silent re-activation).

**Q: CÃ³ cáº§n internet Ä‘á»ƒ dÃ¹ng app khÃ´ng?**
A: Chá»‰ cáº§n internet khi activate láº§n Ä‘áº§u. Sau Ä‘Ã³ cÃ³ thá»ƒ offline (trong 30 ngÃ y cho Ä‘áº¿n khi token háº¿t háº¡n).

---

## Support

Náº¿u cáº§n há»— trá»£:
- Email: support@dangthanhson.com
- Docs: https://docs.dangthanhson.com
- GitHub Issues: https://github.com/your-repo/issues

---

**License:** MIT
**Version:** 1.0.0
**Last Updated:** 2024-12-05
